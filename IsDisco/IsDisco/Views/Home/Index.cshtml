@using IsDisco.Controllers;
@using Newtonsoft.Json.Linq;
@using System.Net;

@{
    ViewData["Title"] = "Musik Ønsker";
    // List<Request> something = new List<Request>();

    // Downloads the music Requests from the backend as a with Json format
    var webclient = new WebClient();
    String Reqresp = webclient.DownloadString("https://isdisco.azurewebsites.net/api/musicrequest");
    var JRequests = JArray.Parse(Reqresp);
    List<Request> requests = new List<Request>();

    // Makes a List<Request> from the Json data from the backend
    for (int i = 0; i < JRequests.Count; i++)
    {
        List<int> downvotes = new List<int>();
        List<int> upvotes = new List<int>();
        List<User> downvoteUsers = new List<User>();
        List<User> upvoteUsers = new List<User>();
        var userId = Convert.ToInt32(JRequests[i]["userId"].ToString());
        var ReqId = Convert.ToInt32(JRequests[i]["id"].ToString());
        var trackId = JRequests[i]["track"]["id"].ToString();
        var downNum = JRequests[i]["downvotes"].Count();
        for (int j = 0; j < downNum; j++)
        {
            downvotes.Add(Convert.ToInt32(JRequests[i]["downvotes"][j].ToString()));
        }
        var upNum = JRequests[i]["upvotes"].Count();
        for (int j = 0; j < upNum; j++)
        {
            upvotes.Add(Convert.ToInt32(JRequests[i]["upvotes"][j].ToString()));
        }
        var downUserNum = JRequests[i]["downvoteUsers"].Count();
        for (int j = 0; j < downUserNum; j++)
        {
            var downUserId = Convert.ToInt32(JRequests[i]["downvoteUsers"][j]["id"].ToString());
            var downUserName = JRequests[i]["downvoteUsers"][j]["fullname"].ToString();
            User downUsr = new User(downUserName, downUserId);
            downvoteUsers.Add(downUsr);
        }
        var upUserNum = JRequests[i]["upvoteUsers"].Count();
        for (int j = 0; j < upUserNum; j++)
        {
            var upUserId = Convert.ToInt32(JRequests[i]["upvoteUsers"][j]["id"].ToString());
            var upUserName = JRequests[i]["upvoteUsers"][j]["fullname"].ToString();
            User upUsr = new User(upUserName, upUserId);
            upvoteUsers.Add(upUsr);
        }
        var thesongName = JRequests[i]["track"]["songName"].ToString();
        var artistName = JRequests[i]["track"]["artistName"].ToString();
        var webplayerLink = JRequests[i]["track"]["webplayerLink"].ToString();
        var date = Convert.ToDateTime(JRequests[i]["timestamp"].ToString());
        Track track = new Track(thesongName, artistName, trackId, webplayerLink);
        Request Reqs = new Request(ReqId, track, userId, date, downvotes, upvotes, upvoteUsers, downvoteUsers);
        requests.Add(Reqs);
    }
    // Sorts the list so the one with most upvotes - downvotes is at the top
    requests.Sort((x, y) => (x.UpVotes.Count - x.DownVotes.Count).CompareTo((y.UpVotes.Count - y.DownVotes.Count)));
    requests.Reverse();
    //requests.Sort((x, y) => -(x.UpVotes.Count - x.DownVotes.Count).CompareTo((y.UpVotes.Count - y.DownVotes.Count)));
 }

<style>
    body {
        background-color: #e9ebee;
    }

    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 95%;
        background-color: white;
        border-radius: 10px;
    }

    td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }

    tr:nth-child(even) {
        background-color: #f4f5f4;
    }
</style>

<script>
function blacklist(x,reqID,trackTitle,trackArtist,trackSpot){
//  var song = document.getElementById("myTable").rows[i].cells.item(1).innerHTML;
 // var author = document.getElementById("myTable").rows[i].cells.item(2).innerHTML;
 console.log(trackTitle);
  // alert( escape(trackTitle));
  var obj = {
      "track": {
        "id":reqID,
        "songName":trackTitle,
        "artistName":trackArtist,
        "image_small_url":"",
        "image_medium_url":"",
        "image_large_url":"",
        "webplayerlink":trackSpot
  }
    };
    var json = JSON.stringify(obj);
  if(confirm("Vil du blackliste denne sang? ")){
  //  alert(reqID+ " " + trackTitle);
    $.ajax('https://isdisco.azurewebsites.net/api/blacklist' , {
        crossDomain: 'true',
        headers: {'Access-Control-Allow-Origin':'*'},
        method: 'post',
        data: json,
        dataType: 'text',
        contentType: 'application/json',
        success: function (response) {
            location.reload();
    //        alert(response + "Success");
        },
        error: function (xhr, status, error) {
            alert(status);
        }
    });
  } 
}
</script>
<body >

<center>
<div class="row">
    <div class="col-sm-12">

        <h1>@ViewData["Title"]</h1>
        <div style="height:72vh;overflow-y:scroll; width: 100%">
            <table id="myTable">
                <tr>
                    <th>Sang</th>
                    <th>Kunstner</th>
                    <th>Tid ønsket</th>
                    <th>Upvotes</th>
                    <th>Muligheder</th>
                </tr>

                @foreach (var Req in requests)
                {
                    <tr>
                        <td>@Req.Track.Title</td>
                        <td>@Req.Track.Artist</td>
                        
                        <!-- @if (DateTime.Now.Subtract(Req.Timestamp).Seconds < 60 && DateTime.Now.Subtract(Req.Timestamp).Minutes < 1)
                        {
                            TimeSpan time = DateTime.Now.Subtract(Req.Timestamp);
                            <td>@Req.Timestamp s siden</td>

                        }
                        else if (DateTime.Now.Subtract(Req.Timestamp).Minutes >= 1)
                        {
                            TimeSpan time = DateTime.Now.Subtract(Req.Timestamp);
                            <td>@time.Minutes m siden</td>
                        } -->

                        <td>@Req.Timestamp.Hour : 
                            @Req.Timestamp.Minute
                        <td> @(Req.UpVotes.Count - Req.DownVotes.Count )</td>
                        <td>
                            <a href=@Req.Track.Spotify_webplayer_link target="_blank"><img src="https://ninalerche.dk/wp-content/uploads/2018/08/spotify-2-logo-png-transparent.png" width="24" height="24" title="Åben i spotify"></a>
                            <a href="#" accept-charset="utf-8" title="blacklist song"  onclick='blacklist(this, "@Req.Track.Track_id","@Req.Track.Title","@Req.Track.Artist", "@Req.Track.Spotify_webplayer_link")'>
                                <img src="https://image.flaticon.com/icons/svg/61/61057.svg" width="24">

                            </a>
                        </td>
                    </tr>

                }

            </table>
        </div>
   </center>
</body>
